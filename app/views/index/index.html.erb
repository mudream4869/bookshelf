<div class="row">
    <div class="col-md-8 col-md-offset-2">
        <%= link_to '新增小說', {:controller => 'books', :action => 'new'}, 
            class: "btn btn-primary" %>

        <%= link_to '掃描更新', {:controller => 'books', :action => 'scan_all'}, 
            class: "btn btn-default btn-scan-all" %>
        
        <div class="btn-group" role="group" aria-label="...">
            <a href="/" class="btn btn-default">無分類</a>
            <% @tags.each do |tag| %>
                <%= link_to tag, {:controller => 'index', :action => 'seive', :tag => tag},
                class: "btn btn-info" %>
            <% end %>
        </div>

        <div class="progress" id="scan-bar" style="display:none;">
            <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
                <span class="sr-only"><span>
            </div>
        </div>
        <table class="table">
            <thead>
                <tr> 
                    <td>書名/連結</td> <td>標籤</td> <td>網站名稱</td> <td>更新時間</td> <td> 操作 </td> 
                </tr>
            </thead>
            <tbody>
            <% @books.each do |book|  %>
            <tr>
                <td>
                    <%= link_to book.title, {:controller => 'books', :action => 'click', :id => book},
                        :target => '_blank', class: "btn btn-link btn-read", tag: "newtag" + book.id.to_s %>
                    <% if book.last_update != nil and (
                            book.last_click == nil or 
                            book.last_click <= book.last_update) %>
                        <span class="label label-success" id="newtag<%= book.id %>">New!</span>
                    <% end %>
                </td>
                <td><%= book.tag %> </td>
                <td><%= book.sitename %></td>
                <td>
                    <% if book.last_update != nil %>
                        <%= book.last_update.in_time_zone('Taipei') %>
                    <% else %>
                        還未掃過
                    <% end %>
                </td>
                <td>
                    <%= link_to '編輯', {:controller => 'books', :action => 'edit', :id => book}, 
                        class: "btn btn-info" %>
                    
                    <% if book.last_update != nil and (
                            book.last_click == nil or 
                            book.last_click <= book.last_update) %>
                     
                        <%= link_to '已讀', {:controller => 'books', :action => 'read', :id => book},
                            class: "btn btn-default btn-read", tag: "newtag" + book.id.to_s %>
                    <% else %>
                        
                        <a href="#" class="btn btn-default" disabled>已讀</a>
                    <% end %>

                    <%= link_to '刪除', {:controller => 'books', :action => 'destroy', :id => book},
                        class: "btn btn-warning btn-delete" %>
                </td>
            </tr>
            <% end %>
            </tbody>
        </table>

<div class="modal fade modal-dialog modal-sm" tabindex="-1" role="dialog" id="myModal" aria-labelledby="myModalLabel">
<!--    <div class="modal-dialog modal-sm"> -->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">警告</h4>
            </div>
            <div class="modal-body">
            確認刪除？
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" data-dismiss="modal" id="btn-check-delete">
                    確認
                </button>
            </div>
        </div>
<!--    </div> -->
</div>

    </div>
</div>

<script language="javascript">

window.onload = init;

delete_url = "";

function init(){
    scan_bar = $("#scan-bar");
    
    $(".btn-delete").click(function(){
        delete_url = $(this).attr("href");
        $('#myModal').modal();
        return false;
    });

    $(".btn-read").click(function(){
        $.post($(this).attr("href"), {}, function(res){});
        $("#" + $(this).attr("tag")).hide();
    });

    $("#btn-check-delete").click(function(){
        $.post(delete_url, {}, function(res){
            window.location.reload();
        });
    });
    
    $(".btn-scan-all").click(function(){
        $.post($(this).attr("href"), {}, function(job_id){
            $('.progress-bar').css('width', '0%').text('0%');
            scan_bar.show();
            var interval;
            interval = setInterval(function(){
                $.ajax({
                url: '/progress-job/' + job_id,
                success: function(job){
                    var stage, progress;

                    // If there are errors
                    if (job.last_error != null) {
                        $('.progress-bar').addClass('progress-bar-danger');
                        scan_bar.hide();
                        clearInterval(interval);
                    }

                    progress = job.progress_current / job.progress_max * 100;
                    // In job stage
                    if (progress.toString() !== 'NaN'){
                        $('.progress-bar').css('width', progress + '%').text(progress + '%');
                    }
                },
                error: function(){
               // Job is no loger in database which means it finished successfuly
                    $('.progress-bar').css('width', '100%').text('100%');
                    scan_bar.hide();
                    clearInterval(interval);
                    window.location.reload();
                }
                });
            },100);
        });
        return false;
    });

}

</script>
